<?php

/**
 * @file
 * Contains content_article.module.
 */

/**
 * Implements hook_theme().
 */
function content_article_theme($existing, $type, $theme, $path) {
  return [
    'articles_block_content' => [
      'variables' => [
        'articles' => [],
        'title' => 'Latest Articles',
        'subtitle' => 'Use Cases',
        'description' => '',
        'show_more_link' => TRUE,
        'more_link_text' => 'View All Articles',
        'more_link_url' => '/articles',
      ],
      'template' => 'articles-block-content',
      'path' => $path . '/templates',
    ],
    'article_video_block' => [
      'variables' => [
        'title' => 'Cultivating success together',
        'subtitle' => 'Watch how we help farmers achieve bigger and better harvests',
        'youtube_id' => '',
        'article_title' => '',
        'article_url' => '',
      ],
      'template' => 'article-video-block',
      'path' => $path . '/templates',
    ],
    'articles_page' => [
      'variables' => [
        'articles' => [],
      ],
      'template' => 'articles-page',
      'path' => $path . '/templates',
    ],
    'node__article__full' => [
      'base hook' => 'node',
      'template' => 'node--article--full',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_node_alter().
 */
function content_article_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  $node = $variables['elements']['#node'] ?? NULL;
  if ($node && $node->bundle() === 'article') {
    $view_mode = $variables['elements']['#view_mode'] ?? 'full';
    $suggestions[] = 'node__article__' . $view_mode;
  }
}

/**
 * Extract YouTube video ID from URL.
 *
 * @param string $url
 *   The YouTube URL.
 *
 * @return string|null
 *   The video ID or NULL if not found.
 */
function content_article_extract_youtube_id($url) {
  if (empty($url)) {
    return NULL;
  }

  // Match various YouTube URL formats.
  $patterns = [
    // Standard watch URL: https://www.youtube.com/watch?v=VIDEO_ID
    '/youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/',
    // Short URL: https://youtu.be/VIDEO_ID
    '/youtu\.be\/([a-zA-Z0-9_-]+)/',
    // Embed URL: https://www.youtube.com/embed/VIDEO_ID
    '/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/',
    // Just the ID.
    '/^([a-zA-Z0-9_-]{11})$/',
  ];

  foreach ($patterns as $pattern) {
    if (preg_match($pattern, $url, $matches)) {
      return $matches[1];
    }
  }

  return NULL;
}

/**
 * Implements hook_preprocess_node().
 */
function content_article_preprocess_node(&$variables) {
  $node = $variables['node'] ?? NULL;
  if ($node && $node->bundle() === 'article') {
    // Extract YouTube video ID for use in templates.
    $video_url = $node->get('field_article_video_url')->value ?? '';
    $youtube_id = content_article_extract_youtube_id($video_url);
    $variables['youtube_video_id'] = $youtube_id;

    // Attach video library if article has video.
    if ($youtube_id) {
      $variables['#attached']['library'][] = 'constructor_theme/video';
    }
  }
}
