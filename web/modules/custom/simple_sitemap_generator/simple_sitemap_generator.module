<?php

/**
 * @file
 * Simple Sitemap Generator module.
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_cron().
 */
function simple_sitemap_generator_cron() {
  $config = \Drupal::config('simple_sitemap_generator.settings');
  $cache_lifetime = $config->get('cache_lifetime') ?: 86400;

  // Check last regeneration time.
  $state = \Drupal::state();
  $last_run = $state->get('simple_sitemap_generator.last_cron', 0);
  $current_time = \Drupal::time()->getRequestTime();

  // Regenerate if cache lifetime has passed.
  if (($current_time - $last_run) >= $cache_lifetime) {
    /** @var \Drupal\simple_sitemap_generator\Service\SitemapGenerator $generator */
    $generator = \Drupal::service('simple_sitemap_generator.generator');
    $generator->clearCache();
    $generator->regenerateAll();

    $state->set('simple_sitemap_generator.last_cron', $current_time);

    \Drupal::logger('simple_sitemap_generator')->notice('Sitemaps regenerated by cron.');
  }
}

/**
 * Implements hook_entity_insert().
 */
function simple_sitemap_generator_entity_insert(EntityInterface $entity) {
  simple_sitemap_generator_invalidate_on_change($entity);
}

/**
 * Implements hook_entity_update().
 */
function simple_sitemap_generator_entity_update(EntityInterface $entity) {
  simple_sitemap_generator_invalidate_on_change($entity);
}

/**
 * Implements hook_entity_delete().
 */
function simple_sitemap_generator_entity_delete(EntityInterface $entity) {
  simple_sitemap_generator_invalidate_on_change($entity);
}

/**
 * Invalidates sitemap cache when content changes.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity that changed.
 */
function simple_sitemap_generator_invalidate_on_change(EntityInterface $entity) {
  // Only care about nodes.
  if ($entity->getEntityTypeId() !== 'node') {
    return;
  }

  $config = \Drupal::config('simple_sitemap_generator.settings');
  $enabled_types = $config->get('enabled_content_types') ?: [];

  // Check if this content type is enabled for sitemap.
  if (!in_array($entity->bundle(), $enabled_types)) {
    return;
  }

  // Clear cache for the domain this node belongs to.
  if ($entity->hasField('field_domain_access') && !$entity->get('field_domain_access')->isEmpty()) {
    /** @var \Drupal\simple_sitemap_generator\Service\SitemapGenerator $generator */
    $generator = \Drupal::service('simple_sitemap_generator.generator');

    foreach ($entity->get('field_domain_access') as $item) {
      $generator->clearCache($item->target_id);
    }
  }
}
