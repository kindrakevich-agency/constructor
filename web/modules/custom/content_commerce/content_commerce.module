<?php

/**
 * @file
 * Contains content_commerce.module.
 */

use Drupal\file\Entity\File;

/**
 * Implements hook_theme().
 */
function content_commerce_theme($existing, $type, $theme, $path) {
  return [
    'product_carousel_block' => [
      'variables' => [
        'products' => [],
        'collection_title' => '',
        'collection_subtitle' => '',
        'collection_brands' => [],
        'collection_link_text' => 'Discover the collection',
        'collection_link_url' => '/products',
      ],
      'template' => 'product-carousel-block',
      'path' => $path . '/templates',
    ],
    'product_sale_hero_block' => [
      'variables' => [
        'badge_text' => 'Hottest Sale',
        'product_title' => '',
        'product_description' => '',
        'original_price' => '',
        'sale_price' => '',
        'currency_symbol' => '$',
        'image_url' => '',
        'product_url' => '',
        'cta_text' => 'Add to Cart',
      ],
      'template' => 'product-sale-hero-block',
      'path' => $path . '/templates',
    ],
    'single_product_block' => [
      'variables' => [
        'product_id' => NULL,
        'product_title' => '',
        'product_price' => '',
        'product_sale_price' => '',
        'currency_symbol' => '$',
        'images' => [],
        'colors' => [],
        'sizes' => [],
        'shipping_info' => '',
        'product_url' => '',
      ],
      'template' => 'single-product-block',
      'path' => $path . '/templates',
    ],
    'products_list_block' => [
      'variables' => [
        'hero_title' => '',
        'hero_subtitle' => '',
        'hero_image' => '',
        'hero_cta_text' => 'Explore the Collection',
        'hero_cta_url' => '/products',
        'feature_cards' => [],
        'categories' => [],
        'products' => [],
      ],
      'template' => 'products-list-block',
      'path' => $path . '/templates',
    ],
    'products_page' => [
      'variables' => [
        'products' => [],
        'categories' => [],
        'current_category' => NULL,
        'currency_symbol' => '$',
      ],
      'template' => 'products-page',
      'path' => $path . '/templates',
    ],
    'node__product__full' => [
      'base hook' => 'node',
      'template' => 'node--product--full',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_node_alter().
 */
function content_commerce_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  $node = $variables['elements']['#node'] ?? NULL;
  if ($node && $node->bundle() === 'product') {
    $view_mode = $variables['elements']['#view_mode'] ?? 'full';
    $suggestions[] = 'node__product__' . $view_mode;
  }
}

/**
 * Implements hook_preprocess_node().
 */
function content_commerce_preprocess_node(&$variables) {
  $node = $variables['node'] ?? NULL;
  if ($node && $node->bundle() === 'product') {
    // Get commerce settings.
    $config = \Drupal::config('content_commerce.settings');
    $variables['currency_symbol'] = $config->get('currency_symbol') ?: '$';
    $variables['currency_position'] = $config->get('currency_position') ?: 'before';
    $variables['shipping_info'] = $config->get('shipping_info') ?: '';

    // Get product data.
    $variables['product_price'] = $node->get('field_product_price')->value ?? 0;
    $variables['product_sale_price'] = $node->get('field_product_sale_price')->value ?? NULL;
    $variables['product_sku'] = $node->get('field_product_sku')->value ?? '';
    $variables['product_in_stock'] = (bool) ($node->get('field_product_in_stock')->value ?? TRUE);

    // Get images.
    $variables['product_images'] = [];
    $images = $node->get('field_product_images')->referencedEntities();
    foreach ($images as $file) {
      $variables['product_images'][] = [
        'url' => \Drupal::service('file_url_generator')->generateAbsoluteString($file->getFileUri()),
        'alt' => $node->get('field_product_images')->alt ?? $node->getTitle(),
      ];
    }

    // Parse colors.
    $variables['product_colors'] = content_commerce_parse_colors($node->get('field_product_colors')->value ?? '');

    // Parse sizes.
    $variables['product_sizes'] = content_commerce_parse_sizes($node->get('field_product_sizes')->value ?? '');

    // Attach library.
    $variables['#attached']['library'][] = 'content_commerce/product';
  }
}

/**
 * Parse color string into array.
 *
 * @param string $color_string
 *   Color string in format "Label:#hex,Label2:#hex2".
 *
 * @return array
 *   Array of colors with 'label' and 'hex' keys.
 */
function content_commerce_parse_colors($color_string) {
  $colors = [];
  if (empty($color_string)) {
    return $colors;
  }

  $pairs = explode(',', $color_string);
  foreach ($pairs as $pair) {
    $parts = explode(':', trim($pair));
    if (count($parts) === 2) {
      $colors[] = [
        'label' => trim($parts[0]),
        'hex' => trim($parts[1]),
      ];
    }
  }

  return $colors;
}

/**
 * Parse size string into array.
 *
 * @param string $size_string
 *   Size string in format "Small,Medium,Large".
 *
 * @return array
 *   Array of size values.
 */
function content_commerce_parse_sizes($size_string) {
  if (empty($size_string)) {
    return [];
  }

  return array_map('trim', explode(',', $size_string));
}

/**
 * Get commerce settings.
 *
 * @return array
 *   Commerce settings array.
 */
function content_commerce_get_settings() {
  $config = \Drupal::config('content_commerce.settings');
  return [
    'currency' => $config->get('currency') ?: 'USD',
    'currency_symbol' => $config->get('currency_symbol') ?: '$',
    'currency_position' => $config->get('currency_position') ?: 'before',
    'shipping_info' => $config->get('shipping_info') ?: '',
    'default_colors' => $config->get('default_colors') ?: '',
    'default_sizes' => $config->get('default_sizes') ?: '',
  ];
}

/**
 * Format price with currency.
 *
 * @param float $price
 *   The price value.
 * @param string $symbol
 *   Currency symbol.
 * @param string $position
 *   Symbol position ('before' or 'after').
 *
 * @return string
 *   Formatted price string.
 */
function content_commerce_format_price($price, $symbol = '$', $position = 'before') {
  $formatted = number_format((float) $price, 2);
  if ($position === 'after') {
    return $formatted . $symbol;
  }
  return $symbol . $formatted;
}

/**
 * Get product image URL.
 *
 * @param \Drupal\node\NodeInterface $node
 *   The product node.
 * @param int $index
 *   Image index (default 0 for first image).
 *
 * @return string|null
 *   Image URL or NULL if not found.
 */
function content_commerce_get_product_image_url($node, $index = 0) {
  $images = $node->get('field_product_images')->referencedEntities();
  if (isset($images[$index])) {
    return \Drupal::service('file_url_generator')->generateAbsoluteString($images[$index]->getFileUri());
  }
  return NULL;
}

/**
 * Get all product images.
 *
 * @param \Drupal\node\NodeInterface $node
 *   The product node.
 *
 * @return array
 *   Array of image data with 'url' and 'alt'.
 */
function content_commerce_get_product_images($node) {
  $images = [];
  $field_values = $node->get('field_product_images');

  foreach ($field_values as $delta => $item) {
    $file = $item->entity;
    if ($file) {
      $images[] = [
        'url' => \Drupal::service('file_url_generator')->generateAbsoluteString($file->getFileUri()),
        'alt' => $item->alt ?: $node->getTitle(),
      ];
    }
  }

  return $images;
}
