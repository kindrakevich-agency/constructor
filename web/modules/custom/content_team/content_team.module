<?php

/**
 * @file
 * Contains content_team.module.
 */

/**
 * Implements hook_theme().
 */
function content_team_theme($existing, $type, $theme, $path) {
  return [
    'team_block_content' => [
      'variables' => [
        'team_members' => [],
        'title' => 'Your Career, Your Connection',
        'subtitle' => 'Join us',
        'description' => '',
        'button_text' => 'View Open Positions',
        'button_url' => '/careers',
      ],
      'template' => 'team-block-content',
      'path' => $path . '/templates',
    ],
    'team_page' => [
      'variables' => [
        'team_members' => [],
      ],
      'template' => 'team-page',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_preprocess_node().
 */
function content_team_preprocess_node(&$variables) {
  $node = $variables['node'] ?? NULL;
  if ($node && $node->bundle() === 'team_member') {
    $view_mode = $variables['elements']['#view_mode'] ?? 'full';
    if ($view_mode === 'full') {
      $variables['other_team_members'] = _content_team_load_other_team_members($node->id());
    }
  }
}

/**
 * Load other team members excluding the current one.
 *
 * @param int $current_nid
 *   The current team member node ID to exclude.
 * @param int $limit
 *   Maximum number of team members to load.
 *
 * @return array
 *   Array of team member data.
 */
function _content_team_load_other_team_members($current_nid, $limit = 4) {
  $team_members = [];
  $current_langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $entity_type_manager = \Drupal::entityTypeManager();

  // Query for other team members.
  $query = $entity_type_manager->getStorage('node')->getQuery()
    ->condition('type', 'team_member')
    ->condition('status', 1)
    ->condition('nid', $current_nid, '<>')
    ->sort('created', 'DESC')
    ->range(0, $limit)
    ->accessCheck(TRUE);

  $nids = $query->execute();

  if (empty($nids)) {
    return $team_members;
  }

  $nodes = $entity_type_manager->getStorage('node')->loadMultiple($nids);

  // Gradient classes for cards.
  $gradient_classes = [
    'bg-gradient-to-br from-blue-400 to-blue-600',
    'bg-gradient-to-br from-purple-400 to-purple-600',
    'bg-gradient-to-br from-green-400 to-green-600',
    'bg-gradient-to-br from-orange-400 to-orange-600',
  ];

  $index = 0;
  foreach ($nodes as $member_node) {
    // Get translation if available.
    if ($member_node->hasTranslation($current_langcode)) {
      $member_node = $member_node->getTranslation($current_langcode);
    }

    // Get photo data.
    $image_url = NULL;
    $image_uri = NULL;
    if ($member_node->hasField('field_team_photo') && !$member_node->get('field_team_photo')->isEmpty()) {
      $image_field = $member_node->get('field_team_photo')->first();
      if ($image_field && $image_field->entity) {
        $image_uri = $image_field->entity->getFileUri();
        $image_url = \Drupal::service('file_url_generator')->generateAbsoluteString($image_uri);
      }
    }

    // Get position.
    $position = '';
    if ($member_node->hasField('field_team_position') && !$member_node->get('field_team_position')->isEmpty()) {
      $position = $member_node->get('field_team_position')->value ?? '';
    }

    $team_members[] = [
      'id' => $member_node->id(),
      'name' => $member_node->getTitle(),
      'position' => $position,
      'url' => $member_node->toUrl()->toString(),
      'image_url' => $image_url,
      'image_uri' => $image_uri,
      'gradient_class' => $gradient_classes[$index % count($gradient_classes)],
    ];

    $index++;
  }

  return $team_members;
}
